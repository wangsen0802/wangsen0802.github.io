<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="wanGISen - ä¸ªäººæŠ€æœ¯åšå®¢ï¼Œä¸“æ³¨äºå‰ç«¯å¼€å‘å’ŒGISæŠ€æœ¯åˆ†äº«" />
    <meta name="keywords" content="å‰ç«¯å¼€å‘,Vue.js,TypeScript,GIS,æŠ€æœ¯åšå®¢" />
    <meta name="author" content="ç‹æ£®" />
    <title>wanGISen - ä¸ªäººæŠ€æœ¯åšå®¢</title>

    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- å†…è”å…³é”®CSSç”¨äºåŠ è½½é¡µé¢ -->
    <style>
      /* é‡ç½®æ ·å¼ */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        overflow: hidden;
      }

      /* é»˜è®¤ä½¿ç”¨æš—è‰²ä¸»é¢˜ */
      body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
      }

      /* åªæœ‰åœ¨ç”¨æˆ·æ˜ç¡®è®¾ç½®äº®è‰²ä¸»é¢˜æ—¶æ‰ä½¿ç”¨äº®è‰² */
      @media (prefers-color-scheme: light) {
        body:not(.user-prefers-dark) {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
      }

      /* åŸç”ŸåŠ è½½é¡µé¢æ ·å¼ */
      .native-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        transition: opacity 0.5s ease-out;
      }

      /* åªæœ‰åœ¨ç”¨æˆ·æ˜ç¡®è®¾ç½®äº®è‰²ä¸»é¢˜æ—¶æ‰ä½¿ç”¨äº®è‰² */
      @media (prefers-color-scheme: light) {
        body:not(.user-prefers-dark) .native-loading {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
      }

      .native-loading.fade-out {
        opacity: 0;
        pointer-events: none;
      }

      .native-loading__container {
        text-align: center;
        animation: fadeInUp 0.8s ease-out;
      }

      .native-loading__logo {
        margin-bottom: 3rem;
      }

      .native-loading__logo-text {
        font-size: 3.5rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        letter-spacing: 2px;
        animation: glow 2s ease-in-out infinite alternate;
      }

      .native-loading__logo-subtitle {
        font-size: 1.2rem;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 300;
        letter-spacing: 1px;
      }

      .native-loading__spinner {
        margin-bottom: 2.5rem;
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .native-loading__text {
        margin-bottom: 2rem;
      }

      .native-loading__title {
        font-size: 1.4rem;
        color: white;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .native-loading__subtitle {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 300;
      }

      .native-loading__progress {
        width: 300px;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
        margin: 0 auto;
      }

      .native-loading__progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        border-radius: 2px;
        width: 0%;
        transition: width 0.3s ease;
        animation: progressGrow 3s ease-out forwards;
      }

      /* èƒŒæ™¯ç²’å­æ•ˆæœ */
      .native-loading__particles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .native-loading__particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
      }

      /* åŠ¨ç”»å®šä¹‰ */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes glow {
        from {
          text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3),
                       0 0 20px rgba(255, 255, 255, 0.2);
        }
        to {
          text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3),
                       0 0 30px rgba(255, 255, 255, 0.4),
                       0 0 40px rgba(79, 172, 254, 0.3);
        }
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @keyframes progressGrow {
        0% { width: 0%; }
        100% { width: 90%; }
      }

      @keyframes float {
        0%, 100% {
          transform: translateY(0) translateX(0);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(-100px) translateX(50px);
          opacity: 0;
        }
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .native-loading__logo-text {
          font-size: 2.5rem;
        }
        .native-loading__logo-subtitle {
          font-size: 1rem;
        }
        .native-loading__title {
          font-size: 1.2rem;
        }
        .native-loading__subtitle {
          font-size: 0.9rem;
        }
        .native-loading__progress {
          width: 250px;
        }
      }

      @media (max-width: 480px) {
        .native-loading__logo-text {
          font-size: 2rem;
        }
        .native-loading__progress {
          width: 200px;
        }
      }

      /* éšè—ä¸»åº”ç”¨ç›´åˆ°åŠ è½½å®Œæˆ */
      #app {
        opacity: 0;
        transition: opacity 0.5s ease-in;
      }

      #app.app-loaded {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <!-- åŸç”ŸåŠ è½½é¡µé¢ -->
    <div id="native-loading" class="native-loading">
      <div class="native-loading__container">
        <!-- Logo åŒºåŸŸ -->
        <div class="native-loading__logo">
          <div class="native-loading__logo-text">wanGISen</div>
          <div class="native-loading__logo-subtitle">ä¸ªäººæŠ€æœ¯åšå®¢</div>
        </div>

        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="native-loading__spinner"></div>

        <!-- åŠ è½½æ–‡å­— -->
        <div class="native-loading__text">
          <div class="native-loading__title">æ­£åœ¨åŠ è½½...</div>
          <div class="native-loading__subtitle">å‡†å¤‡è¿›å…¥æŠ€æœ¯ä¸–ç•Œ</div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="native-loading__progress">
          <div class="native-loading__progress-bar"></div>
        </div>
      </div>

      <!-- èƒŒæ™¯ç²’å­ -->
      <div class="native-loading__particles">
        <div class="native-loading__particle" style="left: 10%; top: 20%; animation-delay: 0s;"></div>
        <div class="native-loading__particle" style="left: 30%; top: 40%; animation-delay: 1s;"></div>
        <div class="native-loading__particle" style="left: 50%; top: 10%; animation-delay: 2s;"></div>
        <div class="native-loading__particle" style="left: 70%; top: 60%; animation-delay: 0.5s;"></div>
        <div class="native-loading__particle" style="left: 90%; top: 30%; animation-delay: 1.5s;"></div>
      </div>
    </div>

    <!-- Vue åº”ç”¨å®¹å™¨ -->
    <div id="app"></div>

    <!-- åº”ç”¨è„šæœ¬ -->
    <script type="module" src="/src/main.ts"></script>

    <!-- åŸç”ŸåŠ è½½é¡µé¢è„šæœ¬ -->
    <script>
      // æ™ºèƒ½åŠ è½½æ£€æµ‹
      (function() {
        let loadingStartTime = Date.now();
        let shouldSkipNativeLoading = false;
        let skipReason = '';

        // æ£€æµ‹æ˜¯å¦åº”è¯¥è·³è¿‡åŸç”ŸåŠ è½½
        function checkLoadingConditions() {
          const now = Date.now();
          const lastVisit = localStorage.getItem('lastVisit');
          const visitCount = parseInt(localStorage.getItem('visitCount') || '0');

          // æ£€æµ‹æ¡ä»¶
          const isRecentVisit = lastVisit && (now - parseInt(lastVisit)) < 30 * 60 * 1000; // 30åˆ†é’Ÿå†…
          const isFrequentUser = visitCount > 5; // è®¿é—®æ¬¡æ•°è¶…è¿‡5æ¬¡
          const hasCache = localStorage.getItem('cacheVerified');

          // å¿«é€Ÿåˆ·æ–°æ£€æµ‹
          const isQuickRefresh = performance.getEntriesByType('navigation').length > 0;

          // å†³å®šæ˜¯å¦è·³è¿‡
          shouldSkipNativeLoading = isRecentVisit || isFrequentUser || (hasCache && isQuickRefresh);

          if (shouldSkipNativeLoading) {
            if (isFrequentUser) skipReason = 'é¢‘ç¹ç”¨æˆ·';
            else if (isRecentVisit) skipReason = 'æœ€è¿‘è®¿é—®';
            else skipReason = 'ç¼“å­˜å¯ç”¨';

            console.log(`ğŸš€ è·³è¿‡åŸç”ŸåŠ è½½é¡µé¢: ${skipReason}`);
          }
        }

        // ç«‹å³æ£€æµ‹
        checkLoadingConditions();

        // è®¾ç½®ä¸»é¢˜ç›¸å…³class
        function initializeTheme() {
          const savedTheme = localStorage.getItem('theme');

          // é»˜è®¤ä½¿ç”¨æš—è‰²ä¸»é¢˜
          if (savedTheme === 'light') {
            document.body.classList.add('user-prefers-light');
          } else {
            document.body.classList.add('user-prefers-dark');
          }
        }

        // ç«‹å³åˆå§‹åŒ–ä¸»é¢˜
        initializeTheme();

        // å¦‚æœåº”è¯¥è·³è¿‡ï¼Œç«‹å³éšè—åŸç”ŸåŠ è½½é¡µé¢
        if (shouldSkipNativeLoading) {
          const nativeLoading = document.getElementById('native-loading');
          const app = document.getElementById('app');

          if (nativeLoading) {
            // æçŸ­çš„æ˜¾ç¤ºæ—¶é—´ï¼Œé¿å…é—ªçƒ
            nativeLoading.style.opacity = '0';
            nativeLoading.style.pointerEvents = 'none';

            // ç›´æ¥æ˜¾ç¤ºåº”ç”¨
            if (app) {
              app.classList.add('app-loaded');
              app.style.opacity = '1';
            }

            // å¿«é€Ÿç§»é™¤åŠ è½½é¡µé¢
            setTimeout(() => {
              nativeLoading.remove();
            }, 100);
          }
        }

        // æ™ºèƒ½åŠ è½½ç›‘å¬
        window.addEventListener('load', function() {
          const elapsedTime = Date.now() - loadingStartTime;

          // æ ¹æ®åŠ è½½æ—¶é—´è°ƒæ•´æ˜¾ç¤ºç­–ç•¥
          let hideDelay = 500; // é»˜è®¤500ms

          if (shouldSkipNativeLoading) {
            hideDelay = 100; // è·³è¿‡æ¨¡å¼ä¸‹æçŸ­å»¶è¿Ÿ
          } else if (elapsedTime < 1000) {
            hideDelay = 1000; // åŠ è½½å¾ˆå¿«æ—¶ï¼Œå»¶é•¿æ˜¾ç¤ºç¡®ä¿ç”¨æˆ·çœ‹åˆ°
          } else if (elapsedTime > 3000) {
            hideDelay = 200; // åŠ è½½è¾ƒæ…¢æ—¶ï¼Œå¿«é€Ÿéšè—
          }

          setTimeout(() => {
            const nativeLoading = document.getElementById('native-loading');
            const app = document.getElementById('app');

            if (nativeLoading && app) {
              // æ·¡å‡ºåŸç”ŸåŠ è½½é¡µé¢
              nativeLoading.classList.add('fade-out');

              // æ˜¾ç¤ºVueåº”ç”¨
              app.classList.add('app-loaded');

              // ç§»é™¤åŸç”ŸåŠ è½½é¡µé¢
              setTimeout(() => {
                nativeLoading.remove();
              }, 500);
            }
          }, hideDelay);
        });

        // æ€§èƒ½ç›‘æ§
        window.addEventListener('load', function() {
          const loadTime = Date.now() - loadingStartTime;
          console.log(`ğŸ“Š é¡µé¢åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${loadTime}ms`);

          // æ›´æ–°è®¿é—®ç»Ÿè®¡
          const now = Date.now();
          localStorage.setItem('lastVisit', now.toString());
          const visitCount = parseInt(localStorage.getItem('visitCount') || '0');
          localStorage.setItem('visitCount', (visitCount + 1).toString());
        });

        // é”™è¯¯å¤„ç†ï¼šå¦‚æœJavaScriptåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        window.addEventListener('error', function(e) {
          const loading = document.getElementById('native-loading');
          if (loading) {
            const title = loading.querySelector('.native-loading__title');
            const subtitle = loading.querySelector('.native-loading__subtitle');
            const spinner = loading.querySelector('.native-loading__spinner');

            if (title) title.textContent = 'åŠ è½½å¤±è´¥';
            if (subtitle) subtitle.textContent = 'è¯·åˆ·æ–°é¡µé¢é‡è¯•';
            if (spinner) spinner.style.display = 'none';
          }
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', function() {
          if (document.hidden) {
            // é¡µé¢éšè—æ—¶ï¼Œå¯ä»¥æ¸…ç†ä¸€äº›èµ„æº
            const nativeLoading = document.getElementById('native-loading');
            if (nativeLoading && shouldSkipNativeLoading) {
              nativeLoading.remove();
            }
          }
        });
      })();
    </script>
  </body>
</html>
